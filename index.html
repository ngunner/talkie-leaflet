<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>A simple leaflet map with Talkie by Kiln.it</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Mapbox -->
    <script src='mapbox-dist/mapbox.js'></script>
    <link href='mapbox-dist/mapbox.css' rel='stylesheet' />

    <!-- Talkie by Kiln.it -->
    <link rel="stylesheet" type="text/css" href="http://kiln.it/talkie/ui/1.0/talkie.css">
    <script src="http://kiln.it/talkie-1.3.min.js"></script>

    <style>
       body { margin:0; padding:0; }
       #map { position:absolute; top:30px; bottom:0; width:100%; }
    </style>
  </head>
  <body>
    <!-- Audio to interact with the map -->
    <div id="controls"></div>
    <audio id="soundtrack" controls="controls">
      <source src="http://orbitist.s3.amazonaws.com/2014/07-talkie-test/Talkie%20Test.ogg" type="audio/ogg">
      <source src="http://orbitist.s3.amazonaws.com/2014/07-talkie-test/Talkie%20Test.mp3" type="audio/mpeg">
    </audio>

    <div id='map'></div>

    <!-- Mapbox example map -->
    <script>
      /* Generic Talkie/Leaflet integration */

      //  If the user interacts with the map while we’re playing,
      //  pause the soundtrack and prepare to revert changes when
      //  the soundtrack continues.
      function initInteractionHandler(timeline, map) {
        function mapMoved() {
          // If this move is triggered by Talkie rather than initiated
          // by the user, do nothing here.
          if (timeline.running) return;

          // Pause the timeline, record the current map position,
          // and revert to it when the user presses play again.
          timeline.pause();
          var center = map.getCenter(),
              zoom = map.getZoom();
          timeline.undoInteraction(function() {
            map.setView(center, zoom);
          });
        }


        // We only need to listen for move events when the timeline is
        // playing. When it isn’t, we’ll get out of the way entirely.
        timeline.onPlay( function() { map.on ("movestart", mapMoved); });
        timeline.onPause(function() { map.off("movestart", mapMoved); });

        // Also call mapMoved immediately, so that if the user moves the map before
        // initially pressing play, we move it back.
        mapMoved();
      }

      //  Used in the timeline to move the map to a specified position
      function moveMap(map, center, zoom) {
        return function() {
          // Record the current map position
          var prev_center = map.getCenter(),
              prev_zoom = map.getZoom();

          // Update the map view
          map.setView(center, zoom);

          // Revert the view when the user scrubs back
          this.setUndo(function() {
            map.setView(prev_center, prev_zoom);
          });
        };
      }


      /* Initialise Leaflet */
      var map = L.mapbox.map('map', 'examples.map-i86nkdio')
        .setView([42.44, -79.33], 9);

      /* Talkie timeline config */
      var timeline = Talkie.timeline("#soundtrack", {
        "00:13": moveMap(map, [40.7298, -74.0027], 13), // New York city
        "00:17": moveMap(map, [42.8963, -78.8822], 12), // Buffalo
        "00:20": moveMap(map, [-41.112, -188.767], 6),  // New Zealand
        "00:24": moveMap(map, [42.8963, -78.8822], 12), // Buffalo
        "00:28": moveMap(map, [42.44, -79.33], 17)      // Fredonia
      });

      // Kick off the interaction handler
      initInteractionHandler(timeline, map);
    </script>
  </body>
</html>
